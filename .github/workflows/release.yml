name: Build and Release

on:
  push:
    tags:
      - 'latest'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'oracle'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Shadow JAR
        run: ./gradlew shadowJar --no-daemon

      - name: Get version from build.gradle.kts
        id: get_version
        run: |
          FULL_VERSION=$(grep -oP 'version\s*=\s*"\K[^"]+' build.gradle.kts)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$FULL_VERSION"
          if [ "$PATCH" = "0" ]; then
            echo "VERSION=${MAJOR}.${MINOR}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          fi

      - name: Create release zip
        run: |
          mkdir -p release_assets
          cp build/libs/dist-*.jar release_assets/
          cp data/config/config.yaml release_assets/
          zip -j dist-${{ steps.get_version.outputs.VERSION }}.zip release_assets/*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.get_version.outputs.VERSION }}"
          tag_name: latest
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: true
          files: dist-${{ steps.get_version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
