name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.0.0, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      sha256: ${{ steps.hash.outputs.sha256 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'oracle'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Shadow JAR
        run: ./gradlew shadowJar --no-daemon

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release zip
        run: |
          mkdir -p release_assets
          cp build/libs/dist-*.jar release_assets/
          cp data/config/config.yaml release_assets/
          zip -j dist-${{ steps.get_version.outputs.VERSION }}.zip release_assets/*

      - name: Calculate SHA256
        id: hash
        run: echo "sha256=$(sha256sum dist-${{ steps.get_version.outputs.VERSION }}.zip | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: MATSim LOS Calculation Image
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist-*.zip 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-dockerfile:
    runs-on: ubuntu-latest
    needs: build-and-release
    
    steps:
      - name: Checkout MATSim_Distributed_Runner (i7 branch)
        uses: actions/checkout@v6
        with:
          repository: ITS-Simulation/MATSim_Distributed_Runner
          ref: i7
          token: ${{ secrets.RUNNER_REPO_PAT }}
          fetch-depth: 0
          
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Update Dockerfile on i7 (main branch)
        run: |
          VERSION="v${{ needs.build-and-release.outputs.version }}"
          ZIP_NAME="dist-${{ needs.build-and-release.outputs.version }}.zip"
          sed -i "s/^ARG VERSION=.*/ARG VERSION=${VERSION}/" Dockerfile
          sed -i "s/^ARG ZIP=.*/ARG ZIP=${ZIP_NAME}/" Dockerfile
          sed -i "s/^ARG SHA256=.*/ARG SHA256=${{ needs.build-and-release.outputs.sha256 }}/" Dockerfile
          git add Dockerfile
          git diff --cached --quiet || git commit -m "feat: update to ${VERSION}"
          git push origin i7
          
      - name: Sync Dockerfile to all other branches
        run: |
          BRANCHES=$(git branch -r | grep -v 'origin/i7' | grep -v 'HEAD' | sed 's|origin/||' | xargs)
          
          for BRANCH in $BRANCHES; do
            echo "Syncing to $BRANCH..."
            git checkout $BRANCH
            git checkout i7 -- Dockerfile
            git add Dockerfile
            git diff --cached --quiet || git commit -m "feat: update to v${{ needs.build-and-release.outputs.version }}"
            git push origin $BRANCH
          done
          
          echo "âœ“ Dockerfile synced across all branches"

